---
title: "Agencja nieruchomości"
author: "grupaA"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)

if (!require(arules)) install.packages("arules")
library(arules)
if (!require(hms)) install.packages("hms")
library(hms)
if (!require(readxl)) install.packages("readxl")
library(readxl)
if (!require(ggplot2)) install.packages("ggplot2")
library(ggplot2)
if (!require(dplyr)) install.packages("dplyr")
library(dplyr)
if (!require(ggstatsplot)) install.packages("ggstatsplot")
library(ggstatsplot)
if (!require(magrittr)) install.packages("magrittr")
library(magrittr)
if (!require(gt)) install.packages("gt")
library(gt)
if (!require(lubridate)) install.packages("lubridate")
library(lubridate)
if (!require(gtsummary)) install.packages("gtsummary")
library(gtsummary)
if (!require(summarytools)) install.packages("summarytools")
library(summarytools)
if (!require(qwraps2)) install.packages("qwraps2")
library(qwraps2)
if (!require(kableExtra)) install.packages("kableExtra")
library(kableExtra)
if (!require(outliers)) install.packages("outliers")
library(outliers)
if (!require(htmltools)) install.packages("htmltools")
library(htmltools)
if (!require(Hmisc)) install.packages("Hmisc")
library(Hmisc)
if (!require(psych)) install.packages("psych")
library(psych)
if (!require(corrplot)) install.packages("corrplot")
library(corrplot)
if (!require(tidyverse)) install.packages("tidyverse")
library(tidyverse)
if (!require(ggforce)) install.packages("ggforce")
library(ggforce)
if (!require(knitr)) install.packages("knitr")
library(knitr)
if (!require(arsenal)) install.packages("arsenal")
library(arsenal)
if (!require(e1071)) install.packages("e1071")
library(e1071)
if (!require(haven)) install.packages("haven")
library(haven)
if (!require(papeR)) install.packages("papeR")
library(papeR)
if (!require(classInt)) install.packages("classInt")
library(classInt)
if (!require(pastecs)) install.packages("pastecs")
library(pastecs)
if (!require(desctable)) install.packages("desctable")
library(desctable)
if (!require(frequency)) install.packages("frequency")
library(frequency)
if (!require(ggpubr)) install.packages("ggpubr")
library(ggpubr)
library(gridExtra)
```

# Wstep

## Opis problemu

Przedmiotem rozważań niniejszego opracowania są ceny wybranych
nieruchomości. Celem badania jest wyselekcjonowanie czynników mogących
istotnie wpływać na cenę domu.

## Baza danych

Podstawą analizy jest baza danych nieruchomości wystawionych na
sprzedaż, dostępnych w pewnej agencji nieruchomości.

```{r}
# wczytanie danych
library(readxl) 
dane <- read.csv("agencja_nieruchomosci.csv")

# wyświetlenie pierwszych wierszy danych
kable(head(dane))
```

## Zmienne

Dane poddane analizie zawieraja ponizsze zmienne:

-   **price** - cena nieruchomości w dolarach

-   **area** - całkowita powierzchnia domu w stopach kwadratowych

-   **bedrooms** - liczba sypialni w domu

-   **bathrooms** - liczba łazienek w domu

-   **stories** - liczba pięter w domu

-   **mainroad** - czy dom jest połączony z główną drogą (Tak/Nie)

-   **guestroom** - czy dom posiada pokój gościnny (Tak/Nie)

-   **basement** - czy dom jest podpiwniczony (Tak/Nie)

-   **hotwaterheating** - czy dom posiada system ogrzewania ciepłej wody
    (Tak/Nie)

-   **airconditioning** - czy dom posiada system klimatyzacji (Tak/Nie)

-   **parking** - liczba miejsc parkingowych dostępnych w budynku

-   **prefarea** - czy dom znajduje się w preferowanym obszarze
    (Tak/Nie)

-   **furnishingstatus** - status umeblowania domu (w pełni umeblowany,
    częściowo umeblowany, nieumeblowany)

```{r}
# struktura danych 
str(dane)
```

# 1. Data Cleansing, Wrangling

## Walidacja danych

### Dane w kolumnach gdzie yes/no

Zbiór danych posiada kolumny zawierajace dane "yes" "no". Zastąpimy te
dane w taki sposób, że: no-"0" yes-"1" dla kolumn: mainroad, guestroom,
basement, hotwaterheating, airconditioning, prefarea.

```{r}
# zamiana yes/no na 1/0
dane$mainroad <- ifelse(dane$mainroad == 'yes', 1, 0)
dane$guestroom  <- ifelse(dane$guestroom  == 'yes', 1, 0)
dane$basement  <- ifelse(dane$basement  == 'yes', 1, 0)
dane$hotwaterheating  <- ifelse(dane$hotwaterheating  == 'yes', 1, 0)
dane$airconditioning  <- ifelse(dane$airconditioning  == 'yes', 1, 0)
dane$prefarea  <- ifelse(dane$prefarea  == 'yes', 1, 0)
```

### Dane z kolumny furnishingstatus

W przypadku kolumny furnishingstatus zmienimy poniższe statusty na
wartości: unfurnished - "0" semi-furnished - "1" furnished - "2"

```{r}
# Zamiana wartości w kolumnie 'furnishingstatus'
dane$furnishingstatus <- ifelse(dane$furnishingstatus == 'unfurnished', 0,
                                  ifelse(dane$furnishingstatus == 'semi-furnished', 1,
                                         ifelse(dane$furnishingstatus == 'furnished', 2, NA)))

```

### Dane z kolumny price

Dane z kolumny price zamienimy z cen w dolarach na ceny w polskich
złotych.

```{r}
# Kurs wymiany
kurs_wymiany <- 4.00
# 1USD=4.00PLN na dzien 4/02/2024

# Przeliczenie cen z dolarów na złote
dane$price <- dane$price * kurs_wymiany

```

### Dane z kolumny area

Natomiast dane z kolumny area zamienimy z powierzchni mierzonej w
stopach kwadratowych na powierzchnię mierzoną w metrach kwadratowych.

```{r}
# Współczynnik konwersji z stóp kwadratowych na metry kwadratowe
wspolczynnik_konwersji <- 0.092903

# Przeliczenie powierzchni z stóp kwadratowych na metry kwadratowe
dane$area <- dane$area * wspolczynnik_konwersji
```

```{r}
# ponowne wyswietlenie struktura danych 
str(dane)
```

### Sprawdzenie czy występują brakujące dane

```{r}
data.frame(braki = sapply(dane, function(x) sum(is.na(x))))

```

W zbiorze nie występują braki danych.

Sprawdzamy jakie skrajne wartosci osiagaja poszczegolne zmienne.

```{r}
# zakres osiąganych wartości dla zmiennych ilościowych
psych::describe(dane[, c(1:5, 11)])

```

Jak widać ceny osiągają milionowe wartości. Aby nie operować bardzo
dużymi liczbami wyrazimy je w mln PLN.

```{r}
# przeliczenia wartości zmiennej price 
dane <- dane %>%
  mutate(price = price/10^6)
```

### Sprawdzenie czy w danych występują duplikaty

```{r}
# Przypisanie danych bez duplikatów do nowej zmiennej
dane_unikalne <- unique(dane)

# Sprawdzenie, czy oryginalne dane zawierają duplikaty
czy_duplikaty <- anyDuplicated(dane) > 0

# Wyświetlenie informacji o duplikatach
if (czy_duplikaty) {
  print("Dane zawierają duplikaty.")
} else {
  print("Brak duplikatów w danych.")
}
```

Sprawdzamy czy w zbiorze danych wystepuja wartosci ujemne. W zadnej
zmiennej wartosci nie powinny byc ujemne.

```{r}
# Sprawdzenie, czy istnieją wartości ujemne w dowolnej kolumnie
czy_sa_ujemne <- any(sapply(dane, function(x) any(x < 0)))

# Wyświetlenie informacji
if (czy_sa_ujemne) {
  print("W ramce danych są wartości ujemne.")
} else {
  print("Brak wartości ujemnych w ramce danych.")
}

```

## Dane odstające

### Sprawdzenie obserwacji odstających -jednowymiarowe

```{r}

par(mfrow = c(2, 2), cex.axis = 1.5, las = 2, mar = c(5, 5, 2, 2))
for (col in colnames(dane)) {
  if (is.numeric(dane[[col]])) {
    boxplot(dane[[col]], 
            main = paste("Wykres pudełkowy dla zmiennej\n", col), 
            ylab = col,
            col = "lightgreen",
            border = "darkgreen",
            pch = 18,
            cex = 1.5,
            cex.main = 1
    )
    outliers <- boxplot.stats(dane[[col]])$out
    points(which(dane[[col]] %in% outliers), outliers, pch = 4, col = "red", cex = 0.5)
  }
}
```

Cena: W zmiennej price, można zaobserwować zmienne odstające powyżej 35
mln PLN. Może być to związane z dużym metrażem nieruchomości, atrakycjną
lokalizacją, liczbą sypialni, lub poziomem umeblowania

Powierzchnia: Można zaobserwować zmienne odstające dla powierzchni
powyżej 850m2. Może być to związane z liczbą pięter, lub dużą ilością
pomieszczeń takich jak sypialnia czy łazienka.

Sypialnie: Istnieją nieruchomości posiadające 5 i 6 sypialni, które to
wartości należą do zmiennych odstających w analizowanym zakresie.
Wiekszość nieruchmości jest w przedziale 2-3 sypialnie.

Lazienki: Znaczaca wiekszosc posiada do 2 lazienek. Natomiast istnieje
zmienna odstająca, wskazująca na 4 łazienki w nieruchomości.

Piętra: Nieruchomosci posiadaja glownie 1-2 pietra, istnieje zmienna
odstajaca, wskazujaca na 4 pietra w nieruchmosci

Miejsca parkingowe: Dla zbioru danych, mozna zaobserwować zmienną
odstającą wskazujacą, że istnieją nieruchomości z 3 miejscami
parkingowymi.

### Sprawdzenie obserwacji odstających - wielowymiarowych

Poniżej przygotowano wykresy rozrzutu dla posiadanych danych.

```{r}
# Stworzenie wykresu punktowego (scatterplot matrix) z dostosowanymi parametrami
par(mfrow = c(1, 1), mar = c(2, 2, 2, 2))  # Ustawienie jednego obszaru wykresu i marginesów

# Funkcja do usuwania brakujących wartości
remove_missing <- function(x) x[!is.na(x)]

# Pobranie danych numerycznych
numeric_data <- dane[, sapply(dane, is.numeric)]

# Narysowanie punktów na wykresie
pairs(numeric_data, pch = 16, col = "darkgreen", cex = 1.5)

# Dodanie oznaczenia dla obserwacji odstających
outliers_x <- lapply(numeric_data, function(x) boxplot.stats(remove_missing(x))$out)
outliers_y <- lapply(numeric_data, function(x) rep(1, length(boxplot.stats(remove_missing(x))$out)))
outliers_x <- unlist(outliers_x)
outliers_y <- unlist(outliers_y)
points(outliers_x, outliers_y, pch = 4, col = "red", cex = 1.5)


```

Poniżej indentyfikacja, w ktorych kolumnach (zmiennych) znajduja sie
wartosci odstajace na podstawie odchylenia sandardowego.

Każdy rząd odpowiada za inną zmienną związaną z nieruchomościami: cena,
powierzchnia, liczba sypialni, liczba łazienek, liczba pięter, główna
droga, pokój gościnny, piwnica, ogrzewanie ciepłej wody, klimatyzacja,
parking, preferowany obszar i stan umeblowania.

Każda kolumna reprezentuje indywidualną obserwację lub nieruchomość.
Zielone paski wskazują, w jakim stopniu każda obserwacja jest uważana za
odstającą dla każdej zmiennej; wyższe paski wskazują, że obserwacja jest
bardziej uważana za odstającą.

Identyfikacja obserwacji odstających w danych liczbowych przy założeniu,
że wartość bezwzględna wieksza niż 3:

```{r}
kolumny <- c("price", "area", "bedrooms", "bathrooms", "stories", "parking")
conditions <- as.data.frame(lapply(dane[, kolumny], function(x) abs(scale(x)) > 3))
summary(conditions)

```

Cena: 6 wartosci odstajacych z 545 nieruchomosci

Powierzchnia: 7 wartosci odstajacych z 545 nieruchomosci

Sypialnie: 2 wartosci odstajace z 545 nieruchomosci

Lazienki: az 11 wartosci odstajacych z 545 nieruchomosci

Pietra: brak wartosci odstajacych - wszystkie nieruchomosci maja podobna
liczbe pieter

Parking: brak wartosci odstajacych - wszystkie nieruchomosci maja
podobna liczbe miejsc parkingowych

### Test Grubbsa (test T)

```{r}
#Test Grubbsa dla zmiennej price (cena)
grubbs.test(dane$price)
```

Test Grubbsa jest stosowany do wykrywania pojedynczych wartości
odstających w zestawie danych.

Wyniki testu Grubbsa można zinterpretować następująco:

G = 4.56217: To jest statystyka testowa Grubbsa. Jeżeli jest duża,
sugeruje to, że dane mogą zawierać wartość odstającą.

U = 0.96167: To jest zmodyfikowana statystyka Grubbsa, która jest
używana do obliczenia p-wartości.

p-value = 0.001126: To jest p-wartość testu. Jeżeli jest mała (zazwyczaj
poniżej 0.05), odrzucamy hipotezę zerową, która zakłada, że nie ma
wartości odstających. W tym przypadku, p-wartość jest mała (0.001126),
więc odrzucamy hipotezę zerową i stwierdzamy, że jest co najmniej jedna
wartość odstająca.

alternative hypothesis: highest value 53.2 is an outlier: To jest
alternatywna hipoteza, która jest przyjmowana, gdy odrzucamy hipotezę
zerową. W tym przypadku, sugeruje ona, że najwyższa wartość (53.2) jest
wartością odstającą.

Poniżej Test Grubbsa dla pozostalych zmiennych:

```{r}
grubbs.test(dane$area)
grubbs.test(dane$bedrooms)
grubbs.test(dane$bathrooms)
grubbs.test(dane$stories)
grubbs.test(dane$parking)
```

**Obserwujemy dane odstajace w zmiennych: price (wczesniej wymienione),
area, bedrooms i bathrooms. W przypadku zmiennych stories oraz parking
nie zaobserwowano wartosci odstajacych.**

# 2. Wizualizacja Danych

W tej części opracowano wizualizację danych w postaci: wizualizacja
ilości, wizualizacja rozkładów, wizualizacja proporcji, wizualizacja
trendów.

## Wizualizacja zmiennych - histogramy

```{r}
library(gridExtra)
# histogramy dla zmiennych ilościowych
plot1 <- ggplot(dane, aes(x = area)) + 
  geom_histogram(colour = "black", fill = "#FFFF99", bins = 10) +
  labs(title = "Area", 
       x = "metry kwadratowe", y = "n") +
  theme(plot.title = element_text(hjust = 0.5, size = 12))

plot2 <- ggplot(dane, aes(x = bedrooms)) + 
  geom_histogram(colour = "black", fill = "#FFFF99", bins = 10) +
  labs(title = "Bedrooms", 
       x = "liczba", y = "n") +
  theme(plot.title = element_text(hjust = 0.5, size = 12))

plot3 <- ggplot(dane, aes(x = bathrooms)) + 
  geom_histogram(colour = "black", fill = "#FFFF99", bins = 10) +
  labs(title = "Bathrooms", 
       x = "liczba", y = "n") +
  theme(plot.title = element_text(hjust = 0.5, size = 12))

plot4 <- ggplot(dane, aes(x = stories)) + 
  geom_histogram(colour = "black", fill = "#FFFF99", bins = 10) +
  labs(title = "Stories", 
       x = "liczba", y = "n") +
  theme(plot.title = element_text(hjust = 0.5, size = 12))

plot5 <- ggplot(dane, aes(x = parking)) + 
  geom_histogram(colour = "black", fill = "#FFFF99", bins = 10) +
  labs(title = "Parking", 
       x = "liczba", y = "n") +
  theme(plot.title = element_text(hjust = 0.5, size = 12))

grid.arrange(plot1, plot2, plot3, plot4, plot5, nrow = 2)
```

W przypadku powierzchni również mamy asymetrię prawostronną. Pozostałe
zmienne to zmienne skokowe (przyjmujące tylko całkowite wartości), przy
tak małym zakresie osiąganych wartości można je też potraktować jak
zmienne jakościowe.

## Jakościowe zmienne objaśniające

```{r,}
# wykres słupkowy dla zmiennej mainroad
tab <- as.data.frame(100*prop.table(table(dane$mainroad)))
plot1 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Mainroad",
       y = "%")

# wykres słupkowy dla zmiennej guestroom
tab <- as.data.frame(100*prop.table(table(dane$guestroom)))
plot2 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Guestroom",
       y = "%")

# wykres słupkowy dla zmiennej basement
tab <- as.data.frame(100*prop.table(table(dane$basement)))
plot3 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Basement",
       y = "%")

# wykres słupkowy dla zmiennej hotwaterheating
tab <- as.data.frame(100*prop.table(table(dane$hotwaterheating)))
plot4 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Hotwaterheating",
       y = "%")

# wykres słupkowy dla zmiennej airconditioning
tab <- as.data.frame(100*prop.table(table(dane$airconditioning)))
plot5 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Airconditioning",
       y = "%")

# wykres słupkowy dla zmiennej prefarea
tab <- as.data.frame(100*prop.table(table(dane$prefarea)))
plot6 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Prefarea",
       y = "%")

# wykres słupkowy dla zmiennej furnishingstatus
tab <- as.data.frame(100*prop.table(table(dane$furnishingstatus)))
plot7 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Furnishingstatus",
       y = "%")

# wykres wspólny
grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, plot7, nrow = 4)
```

Mamy duże dysproporcje w rozkładzie kategorii poszczególnych zmiennych.

## Wizualizacja rozkładów

### Histogramy rozkładu cen nieruchomości względem zmiennych

Poniżej przedstawiamy analizę rozkładu cen nieruchomości w zależności od
różnych cech, takich jak liczba sypialni, łazienek czy pięter.
Histogramy prezentują, jak ceny zmieniają się w zależności od tych cech,
co pomaga zrozumieć ich wpływ na wartość nieruchomości.

```{r}
# Tworzenie histogramu wzgledem liczby sypialni
ggplot(dane, aes(x = bedrooms, y = price, fill = factor(bedrooms))) +  
  geom_histogram(stat = "identity", position = "dodge", color = "black") +  
  labs(title = "Rozkład cen względem liczby sypialni", x = "Liczba sypialni", y = "Cena") + 
  theme_minimal() + 
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu wzgledem liczby lazienek
ggplot(dane, aes(x = bathrooms, y = price, fill = factor(bathrooms))) +  
  geom_histogram(stat = "identity", position = "dodge", color = "black")+ 
  labs(title = "Rozkład cen względem liczby lazienek", x = "Liczba lazienek", y = "Cena") + 
  theme_minimal() + 
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu wzgledem liczby pieter
ggplot(dane, aes(x = stories, y = price, fill = factor(stories))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem liczby pięter", x = "Liczba pięter", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu cen względem głównej drogi (mainroad)
ggplot(dane, aes(x = mainroad, y = price, fill = factor(mainroad))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem głównej drogi", x = "Główna droga (1=Tak, 0=Nie)", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu cen względem pokoju gościnnego (guestroom)
ggplot(dane, aes(x = guestroom, y = price, fill = factor(guestroom))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem pokoju gościnnego", x = "Pokój gościnny (1=Tak, 0=Nie)", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu cen względem piwnicy (basement)
ggplot(dane, aes(x = basement, y = price, fill = factor(basement))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem piwnicy", x = "Piwnica (1=Tak, 0=Nie)", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu cen względem ogrzewania wodą (hotwaterheating)
ggplot(dane, aes(x = hotwaterheating, y = price, fill = factor(hotwaterheating))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem ogrzewania wodą", x = "Ogrzewanie wodą (1=Tak, 0=Nie)", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu cen względem klimatyzacji (airconditioning)
ggplot(dane, aes(x = airconditioning, y = price, fill = factor(airconditioning))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem klimatyzacji", x = "Klimatyzacja (1=Tak, 0=Nie)", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu cen względem parkingu (parking)
ggplot(dane, aes(x = parking, y = price, fill = factor(parking))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem parkingu", x = "Parking (1=Tak, 0=Nie)", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu cen względem preferowanej okolicy (prefarea)
ggplot(dane, aes(x = prefarea, y = price, fill = factor(prefarea))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem preferowanej okolicy", x = "Preferowana okolica (1=Tak, 0=Nie)", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu cen względem statusu umeblowania (furnishingstatus)
ggplot(dane, aes(x = furnishingstatus, y = price, fill = factor(furnishingstatus))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem statusu umeblowania", x = "Status umeblowania", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

```

### Wizualizacja gęstości cen względem zmiennych

W poniższym fragmencie kodu prezentujemy analizę gęstości cen
nieruchomości względem różnych cech, takich jak liczba sypialni,
łazienek, pięter itp. Wizualizacje gęstości pomagają zrozumieć, jak
zmienia się rozkład cen w zależności od poszczególnych cech
nieruchomości.

Gęstość w kontekście analizy danych oznacza, jak często i w jakim
stopniu wartości zmiennej (np. ceny nieruchomości) skupiają się w
określonych przedziałach. Wykres gęstości pokazuje, jak rozkładają się
wartości zmiennej na osi numerycznej, gdzie wyższe wartości oznaczają
obszary większego skupienia. Innymi słowy, obszary wyższej gęstości
wskazują na większe prawdopodobieństwo wystąpienia wartości w danym
przedziale, co pozwala lepiej zrozumieć charakterystykę danych i ich
rozkład.

```{r}

# Wizualizacji gęstości cen względem liczby sypialni
ggplot(dane, aes(x = price, fill = factor(bedrooms))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem liczby sypialni", x = "Cena", y = "Gęstość") +
  theme_minimal()


# Wizualizacji gęstości cen względem liczby łazienek
ggplot(dane, aes(x = price, fill = factor(bathrooms))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem liczby łazienek", x = "Cena", y = "Gęstość") +
  theme_minimal()


# Wizualizacji gęstości cen względem liczby pięter
ggplot(dane, aes(x = price, fill = factor(stories))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem liczby pięter", x = "Cena", y = "Gęstość") +
  theme_minimal()

# Wizualizacji gęstości cen względem dostępu do głównej drogi
ggplot(dane, aes(x = price, fill = factor(mainroad))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem dostępu do głównej drogi", x = "Cena", y = "Gęstość") +
  theme_minimal()

# Wizualizacji gęstości cen względem posiadania pokoju gościnnego
ggplot(dane, aes(x = price, fill = factor(guestroom))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem posiadania pokoju gościnnego", x = "Cena", y = "Gęstość") + theme_minimal()

# Wizualizacji gęstości cen względem posiadania piwnicy
ggplot(dane, aes(x = price, fill = factor(basement))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem posiadania piwnicy", x = "Cena", y = "Gęstość") +
  theme_minimal()

# Wizualizacji gęstości cen względem posiadania ogrzewania wodą
ggplot(dane, aes(x = price, fill = factor(hotwaterheating))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem posiadania ogrzewania wodą", x = "Cena", y = "Gęstość") +
  theme_minimal()

# Wizualizacji gęstości cen względem posiadania klimatyzacji
ggplot(dane, aes(x = price, fill = factor(airconditioning))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem posiadania klimatyzacji", x = "Cena", y = "Gęstość") +
  theme_minimal()

# Wizualizacji gęstości cen względem posiadania parkingu
ggplot(dane, aes(x = price, fill = factor(parking))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem posiadania parkingu", x = "Cena", y = "Gęstość") +
  theme_minimal()

# Wizualizacji gęstości cen względem preferowanej okolicy
ggplot(dane, aes(x = price, fill = factor(prefarea))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem preferowanej okolicy", x = "Cena", y = "Gęstość") +
  theme_minimal()


# Wizualizacji gęstości cen względem stanu umeblowania
ggplot(dane, aes(x = price, fill = factor(furnishingstatus))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem stanu umeblowania", x = "Cena", y = "Gęstość") +
  theme_minimal()
```

**Gęstość cen względem liczby sypialni** Analizujac wykres gestosci ceny
wzgledem liczby pokoi mozemy zaobserwowac, ze największa gęstość cen
występuje dla mieszkań z jedną sypialnią, cena rośnie wraz ze wzrostem
liczby sypialni oraz, że mieszkania z większą liczbą sypialni są
rzadziej dostępne na rynku, co jest widoczne na wykresie przez niższą
gęstość.

**Gęstość cen względem liczby łazienek** Największa gęstość cen
występuje dla mieszkań z jedną łazienką. W mniejszym stopniu występują
mieszkania z kolejno dwoma i trzema łazienkami. Cena nierychomości
wzrasta wraz z ilością łazienek, na co mogą mieć wpływ również inne
udogodnienia dostęne w nieruchomości.

**Gęstość cen względem liczby pięter** Wizualizacji gęstości cen
względem liczby pięter pokazuje, że mieszania te występują w podobnej
ilości. Różnicą, na którą powinniśmy zwrócić uwagę jest cena
nieruchomości która rośnie wraz z ilością liczby pięter.Cena wzrasta
adekwatnie do ilości pięter.

**Gęstość cen względem dostępu do drogi głównej** Wizualizacji gęstości
cen względem dostępu do głównej drogi wskazuje na znaczną przewagę
liczby mieszkań nieposiadających dostępu do drogi nad posiadającymi.
Gęstość ceny nie wskazuje, aby był to czynnik mający dużą wartość dla
nieruchomości, ceny dla mieszkań z dostępem do drogi głównej są jednak
wyższe niż dla tych, które dostępu nie posiadają.

**Gęstość cen względem posiadania pokoju gościnnego** Analizujac wykres
gestosci ceny wzgledem posiadania pokoju gościnnego można zauważyć że
gęstość ich występowania jest bardzo podobna. Różnicą między tymi
mieszkaniami jest cena, te z pokojem gościnnym są droższe od mieszkań
bez pokoju gościnnego. Wpływać na to może między innymi dodatkowa
powierzchnia dostępna w mieszkaniu posiadającym to udogodnienie.

**Gęstość cen względem posiadania piwnicy** Analizujac wykres gestosci
ceny wzgledem posiadania piwnycy zauważamy, że zarówno mieszkania z jak
i bez piwnicy występują w dużej ilości na rynku nieryuchomości, przewagę
stanowią jednak mieszkania bez dostepu do piwnicy. Mieszkania te
charakteryzują się również adekwatnie większą ceną na rynku.

**Gęstość cen względem posiadania ogrzewania wodą** Analizujac wykres
gestosci ceny wzgledem posiadania ogrzewania wodą mozna zauważyć, że
znaczna przewagę na rynku nieruchomości maja mieszkania, które nie
posiadają systemu ogrzewania wodą. Jeśli chodzi o cenę nieruchomości
droższe sa mieszkania posiadające taki system ogrzewania.

**Gęstość cen względem posiadania klimatyzacji** Analizujac wykres
gestosci ceny wzgledem zauwazyc można dużą różnicę w gęstości
występowania tego udogodnienia, zdecydowanie większą ilość mieszkań na
rynku nieruchomości zajmują mieszkania nie posiadające klimatyzacji.
Wykres wskazuje również na znacznie wyższe ceny nieruchomosci, które
klimatyzacje posiadają.

**Gęstość cen względem posiadania parkingu** Analizujac wykres gestosci
ceny wzgledem posiadania miejsca parkingowego możemy zauważyć że
najwiekszą gestością charakteryzują sie mieszkania bez żadnego miejsca
parkingowego. Podobna ęstść występuje dla mieszkań posiadających jedno,
dwa bądź trzy miejsca parkingowe. Nie można jednoznacznie stwierdzić
jaka ilosć miejsc parkingowych najbardziej podbija cene nieruchomości,
jednakże zdecydowanie można stwierdzić że ceny mieszkań posiadających
przynajmniej jedno miejsce parkingowe sa wyższe niż ceny mieszkań, które
żadnego miejsca parkingowego nie posiadają.

**Gęstość cen względem preferowanej okolicy** Analizujac wykres gestosci
ceny wzgledem preferowanej okolicy zauważyc można przewagę nieruchoości,
które w preferowanej okolicy się nie znajdują. Jeśli chodzi o cene
nieruchomości względem miejsca, znacznie wyższymi cenami charakteryzują
sie nieruchomości znajdujące się w preferowanej okolicy.

**Gęstość cen względem stanu umeblowania** Analizujac wykres gestosci
ceny wzgledem stanu umeblowania zauwazamy, że mieszkania nieumeblowane i
wpółumeblowane zdecydowanie przeważaja nad mieszkaniami które są
umeblowane w pełni. Analizując również ceny tych nieruchomości widać, że
im bardziej mieszkanie jest umeblowane tym wyższa jest jego wartość.

## Wizualizacja proporcji

```{r}
library(dplyr)   
library(ggplot2) 
dane_wiz <- dane
dane_wiz <- reshape2::melt(dane_wiz, id.vars = c("price", "area"))
dane_wiz <- dplyr::count(dane_wiz, variable, value)
dane_wiz <- dplyr::mutate(dane_wiz, percentage = n / sum(n))

#Stwórz wykres
wykres <- ggplot2::ggplot(dane_wiz, ggplot2::aes(x = value, y = percentage, fill = variable))
wykres <- wykres + ggplot2::geom_bar(stat = "identity", position = "dodge")
wykres <- wykres + ggplot2::facet_wrap(~variable, scales = "free", ncol = 4)
wykres <- wykres + ggplot2::theme_minimal()
wykres <- wykres + ggplot2::labs(x = "Wartości", y = "Proporcja (%)", fill = "Zmienna (kolumna)", title = "Proporcje zmiennych w zbiorze danych")

print(wykres)

dane %>%
  gather(key = "variable", value = "value", -price, -area) %>%
  group_by(variable, value) %>%
  summarise(n = n()) %>%
  mutate(percentage = n / sum(n)) -> dane_wiz

#Stwórz wykres
ggplot(dane_wiz, aes(x = value, y = percentage, fill = variable)) +
  geom_col(position = "dodge") +
  facet_wrap(~variable, scales = "free", ncol = 4)
  theme_minimal() +
  labs(x = "Wartości", y = "Proporcja (%)", fill = "Zmienna (kolumna",
       title = "Proporcje zmiennych w zbiorze danych")
```

Powyższa wizualizacja proporcji nie uwzględnia zmiennej price oraz
zmiennej area. Ponizej wizualizacja z uwzględnieniem tych dwóch
zmiennych, jednak ze względu na chatakterystykę danych, z podziałem na 3
przedziały. Wykres pokazuje, jak różne wartości różnych zmiennych są
rozłożone w zbiorze danych. Można na nim łatwo zobaczyć, które wartości
dominują, a które występują rzadziej. Ponadto, dzięki facetowaniu, można
porównać rozkłady różnych zmiennych na osobnych panelach, co ułatwia
analizę danych. Przykładowo dla pierwszego wykresu widzimy przewagę
ilosci nieruchomosci z klimatyzacją nad nieruchomosciami, które
klimatyzacji nie posiadają. Drugi wykres wskazuje, że udział w rynku
nieruchomosci mieszkań bez piwnicy jest wyższy niż dla mieszkań które te
piwnicę posiadają. Jesli chodzi o wykres przedstawiający ilosć lazienek
zauwazamy, że trendują mieszkania posiadające jedną łazienkę, w
przypadku sypialni najczęściej w nieruchomościach znajdują się 3.

```{r}
library(dplyr)
library(ggplot2)

#Tworzenie kategorii cen i powierzchni oraz obliczanie liczby obserwacji w każdej kategorii
dane_proporcje <- dane %>%

#library(tidyverse)
#???
# Podział zmiennych "price" i "area" na przedziały
dane %>%
  mutate(price_category = cut(price, breaks = 3),
         area_category = cut(area, breaks = 3)) %>%
  count(price_category, area_category) %>%
  mutate(percentage = n / sum(n))

#Tworzenie wizualizacji proporcji dla każdej kategorii
ggplot(dane_proporcje, aes(x = price_category, y = area_category, fill = percentage)) +
  geom_tile() +
  scale_fill_gradient(low = "lightblue", high = "darkblue") +
  labs(x = "price", y = "area", fill = "Proporcje (%)") +
  theme_minimal() +
  ggtitle("Proporcje w zależności od ceny i powierzchni")


```

Powyższa mapa cieplna jest wizualizacją proporcji zmiennych price i
area. Oś x przedstawia ceny (price z podzialem na 3 przedziały,
natomiast oś y przedstawia zmienną area również z podziałem na 3
przedziały. Większość danych dotyczy nieruchomości o średniej cenie i
sredniej powierzchni. Najmniej danych (blisko 0%) dotyczy nieruchomości
o niskiej cenie i dużej powierzchni oraz o wysokiej cenie i małej
powierzchni.

```{r}


dane %>%
  ggplot(aes(price, area,size = bathrooms, color = factor(stories))) +
  labs(x = "Cena",
       y = "Powierzchnia",
       size = "Liczba sypialni \n(rozmiar punktorow)",
       color = "Liczba lazienek \n(kolor punktorow)") +
  geom_point(alpha = 0.8)


```

Powyższy wykres pnktowy, wizualizuje zależność między ceną a
powierzchnią nieruchomości. Rozmiar punktów reprezentuje liczbę
sypialni, a kolor wskazuje na liczbę łazienek. Możemy zauważyć, że
istnieje koncentracja nieruchomości o niższych cenach i mniejszych
powierzchniach. Nieruchomości z większą liczbą łązienek są zazwyczaj
większe i droższe. Nie ma wyraźnej liniowej zależności między ceną a
powierzchnią, co wskazuje na zmieność cen nieruchomości i wskazuje, że
inne czynniki, również wpływają na cenę.

## Wizualizacja trendów.

Wykres rozrzutu (scatter plot) jest jednym z podstawowych narzędzi do
analizy trendów w danych. Wizualizuje relacje miedzy dwoma zmienymi, w
tym przypadku powierzchni do ceny co moze pomoc w indenyfkacji trendów.

```{r}
# wykres rozrzutu
ggplot(dane, aes(x = area, y = price)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)


```

Mamy tutaj zależność dodatnią, czym większa powierzchnia domu, tym
wyższa cena. Jednak układ punktów nie wskazuje na ściśły związek
liniowy. Ponieważ jednak nie ma tu też zależności nieliniowej.

# 3. Analiza opisowa

W naszym zbiorze danych występują zmienne ilościowe: price, area,
bedrooms, bathrooms, stories, parking; oraz zmienne jakościowe:
mainroad, guestroom, basement, hotwaterheating, airconditioning,
prefarea, furnishingstatus.

## Data wragling dla rozdziału dot. analizy opisowej

```{r wrangling, include=TRUE}
# Przekształcenie danych jakościowych
dane$mainroad <- as.numeric(dane$mainroad) 
dane$guestroom <- as.numeric(dane$guestroom) 
dane$basement <- as.numeric(dane$basement)
dane$hotwaterheating <- as.numeric(dane$hotwaterheating)
dane$airconditioning <- as.numeric(dane$airconditioning) 
dane$prefarea <- as.numeric(dane$prefarea)  
dane$furnishingstatus <- as.numeric(dane$furnishingstatus) 

# Przekształcenie danych numerycznych (jeśli wymaga tego analiza)
dane$price <- as.numeric(dane$price)
dane$area <- as.numeric(dane$area)
dane$bedrooms <- as.numeric(dane$bedrooms)
dane$bathrooms <- as.numeric(dane$bathrooms)
dane$stories <- as.numeric(dane$stories)
dane$parking <- as.numeric(dane$parking)

```

## Wizualizacja zmiennej price

```{r}
library(ggplot2)

# Tworzenie wykresu słupkowego
wykres_slupkowy <- ggplot(dane, aes(x = price)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(title = "Rozkład cen mieszkań", x = "Cena (w mln PLN)", y = "Liczba mieszkań") +
  theme_minimal()

# Wyświetlenie wykresu
print(wykres_slupkowy)
 
```

Za pomocą Metody Sturgesa, wyznaczamy przedziały dla zmiennej price

```{r}
# Dane do analizy
ceny_mieszkan <- dane$price

# Wykorzystanie metody Sturgesa do automatycznego wyznaczenia liczby przedziałów
liczba_przedzialow <- nclass.Sturges(ceny_mieszkan)

# Wykorzystanie liczby przedziałów w funkcji cut()
przedzialy <- cut(ceny_mieszkan, breaks = liczba_przedzialow)

table(przedzialy)

```

## Tabele liczności oraz TAI

W pierwszym etapie naszej analizy pogrupujemy dane na 3 przedziały w
postać tabeli częstości.

A następnie przygotujemy rozkład cen mieszkań w naszej próbie i
zweryfikujmy poprawność tabelaryczną za pomocą miary TAI:

```{r}
# Przekształcenie cen mieszkań na zakresy zgodne z projektem2
etykiety_projekt2 <- c("(6.95,11.2] mln PLN","(11.2,15.4] mln PLN", "(15.4,19.6] mln PLN", "(19.6,23.8] mln PLN", "(23.8,28] mln PLN", "(28,32.2] mln PLN", "(32.2,36.4] mln PLN", "(36.4,40.6] mln PLN", "(40.6,44.8] mln PLN", "(44.8,49] mln PLN", "(49,53.2] mln PLN")
limits_projekt2 <- cut(dane$price, c(6.95, 11.2, 15.4, 19.6, 23.8, 28, 32.2, 36.4, 40.6, 44.8, 49, 53.2), labels = etykiety_projekt2)
tabela2 <- freq(limits_projekt2, type = "html")

```

```{r}
kbl(tabela2, caption = "Mieszkania we Wrocławiu - ceny w PLN - Projekt2") %>%
    kable_material(c("striped", "hover"))
tab2 <- classIntervals(dane$price, n = 11, style = "fixed", fixedBreaks = c(6.95, 11.2, 15.4, 19.6, 23.8, 28, 32.2, 36.4, 40.6, 44.8, 49, 53.2))
jenks.tests(tab2)


```

Otrzymane wartości w wyniku testu Jena to oprócz classes, które
informuje o ilości przedziałów(11 przedziałów), Goodness of fit(Jest to
miara dobrej dopasowania danych do podziału na klas)o wartości 0.9752304
wskazuje na to, jak dobrze dane pasują do podziału na trzy klasy cenowe.
Im bliżej wartości 1, tym lepsze dopasowanie.Tabular accuracy (TAI),
jako miara dokładności tabeli częstości w odniesieniu do danych,
przedstawia wartość 0.8248048, która oznacza, jak dobrze tabela
częstości odzwierciedla rzeczywisty rozkład danych. Im bliżej wartości
1, tym dokładniejsza jest tabela częstości.

Wartości te wskazują na dobre dopasowanie podziału cen mieszkań na trzy
przedziały oraz na poprawność tabelaryczną w odniesieniu do tych danych

```{r histogram, echo=FALSE}

hist(dane$price, breaks = c(6.95, 11.2, 15.4, 19.6, 23.8, 28, 32.2, 36.4, 40.6, 44.8, 49, 53.2), col = "green", probability = TRUE,
     main = "Rozkład cen mieszkań w zależności od stanu umeblowania", ylim = c(0, 0.1), xlab = "Cena mieszkania (mln PLN)")
lines(density(dane$price[dane$furnishingstatus == "0"]), col = 2)
lines(density(dane$price[dane$furnishingstatus == "1"]), col = 3)
lines(density(dane$price[dane$furnishingstatus == "2"]), col = 4)
legend("topright", legend = c("nieumeblowane", "średnio_umeblowane", "calkowicie_umeblowane"),
       col = c(2, 3, 4), lty = 1:2, horiz = FALSE, box.lty = 0, cex = 1)


```

```{r boxplot, echo=FALSE}
boxplot(dane$price ~ dane$furnishingstatus,
        xlab = "Stan umeblowania",
        ylab = "Cena mieszkania (mln PLN)",
        names = c("Nieumeblowane", "Średnio umeblowane", "Całkowicie umeblowane"))

```

Dzięki wykresie pudełkowym, otrzymaliśmy rozkład cen mieszkań w różnych
kategoriach stanu umeblowania, co pozwala porównać mediany, kwartyle i
zakresy cen mieszkań między różnymi kategoriami:

Nieumeblowane mieszkania: Mediana ceny wynosi około 20 mln PLN. Pierwszy
i trzeci kwartyl są blisko mediany, co wskazuje na mniejszą zmienność
cen. Istnieją wartości odstające powyżej 30 mln PLN.

Średnio umeblowane mieszkania: Mediana ceny wynosi około 25 mln PLN.
Pierwszy i trzeci kwartyl są bardziej rozproszone niż dla
nieumeblowanych mieszkań, co wskazuje na większą zmienność cen. Istnieje
kilka wartości odstających powyżej 30 mln PLN.

Całkowicie umeblowane mieszkania: Mediana ceny wynosi również około 25
mln PLN. Zakres międzykwartylny jest szeroki, z pierwszym kwartylem
poniżej 20 mln PLN i trzecim kwartylem powyżej 30 mln PLN, co wskazuje
na dużą zmienność cen. Istnieje kilka wartości odstających powyżej 40
mln PLN.

## ggplot2 plots

W tym rozdziale przedstawimy te same wykresy, ale z wykorzystaniem
pakietów ***ggplot2*** i ***ggpubr***.

```{r histogram2, echo=FALSE}
library(dplyr)

# Przekształcenie kolumny furnishingstatus na czynnik z odpowiednimi poziomami
dane$furnishingstatus <- factor(dane$furnishingstatus,
                                        levels = c("0", "1", "2"),
                                        labels = c("nieumeblowane", "średnio umeblowane", "umeblowane"))

# Density plot of "price"
density.p <- ggdensity(dane, x = "price", 
                       fill = "furnishingstatus", palette = "jco") +
            stat_overlay_normal_density(color = "red", linetype = "dashed")

# Liczymy statystyki wg stanu umeblowania:
stable <- desc_statby(dane, measure.var = "price",
                      grps = "furnishingstatus")
stable <- stable[, c("furnishingstatus", "length", "mean", "sd")]

# Wykres, szablon "medium orange":
stable.p <- ggtexttable(stable, rows = NULL, 
                        theme = ttheme("mOrange"))

# Podpisujemy wykres:
text <- paste("Ceny mieszkań wg stanu umeblowania.",
              "Losowa próba 200 mieszkań.",
               sep = " ")
text.p <- ggparagraph(text = text, face = "italic", size = 11, color = "black")

# Aranżujemy wykresy na tym samym panelu:
ggarrange(density.p, stable.p, text.p, 
          ncol = 1, nrow = 3,
          heights = c(1, 0.5, 0.3))

```

Ggplot2 pozwala na pokazanie średniej wartości dla każdej grupy. Wykres
przedstawia rozkład cen mieszkań w zależności od ich umeblowania:
nieumeblowane, średnio umeblowane i umeblowane. Mieszkania umeblowane są
zazwyczaj droższe, co widać po wyższej średniej cenie. Wykres gęstości
pokazuje znaczne pokrywanie się cen pomiędzy różnymi kategoriami, co
wskazuje na różnorodność cen w ramach każdego statusu umeblowania.

```{r boxplot2, echo=FALSE}

ggplot(dane, aes(x=mainroad, y=price)) +
    geom_boxplot(alpha=0.7) +
    stat_summary(fun="mean", geom="point", shape=20, size=5, color="red", fill="red") +
    geom_jitter() +
    facet_grid(~factor(prefarea, labels = c("Obszar niepreferowany", "Obszar preferowany"))) +
    scale_fill_brewer(palette="Set1")

#???

ggplot(dane_analiza, aes(x=mainroad, y=price)) +
    geom_boxplot(alpha=0.7) +
    stat_summary(fun="mean", geom="point", shape=20, size=5, color="red", fill="red") +
    geom_jitter() +
    facet_grid(~factor(prefarea, labels = c("Obszar niepreferowany", "Obszar preferowany"))) +
    scale_fill_brewer(palette="Set1")


```

Wykres przedstawia rozkład cen nieruchomości (price) w zależności od ich
bliskości do głównej drogi (mainroad), z podziałem na preferowane i
niepreferowane obszary. Czerwone punkty reprezentują średnią cenę dla
każdej kategorii. Wydaje się, że średnia cena nieruchomości jest wyższa,
gdy nieruchomość znajduje się blisko głównej drogi, niezależnie od
preferencji obszaru.

Wydaje się, że jest mniej nieruchomości w preferowanym obszarze, które
nie mają dostępu do głównej drogi (mainroad=0). Można to interpretować
jako wskazówkę, że większość nieruchomości w preferowanych obszarach ma
dostęp do głównej drogi.

## Grupowanie grafik

```{r facet1, echo=FALSE}
plot702 <- ggplot(dane, aes(price, bathrooms)) + 
  geom_abline() +
  geom_jitter(width = 0.1, height = 0.1) 
plot702 + facet_wrap(~furnishingstatus)

```

Wykres przedstawia zależność między ceną nieruchomości (price) a liczbą
łazienek (bathrooms), z podziałem na status umeblowania
(furnishingstatus). Czarne punkty reprezentują poszczególne
nieruchomości. Dla nieruchomości "nieumeblowane" i "średnio umeblowane",
ceny generalnie rosną wraz ze wzrostem liczby łazienek. Dla
nieruchomości "umeblowane", ceny wydają się być podobne niezależnie od
liczby łazienek, ale są generalnie wyższe w porównaniu do innych
kategorii umeblowania.

## Statystyki opisowe

```{r}
summary(dane)
```

**price** - Średnia cena badanych nieruchomości to 19.1 mln PLN. Dla
połowy nieruchomości cena nie przekracza 17.36 mln PLN Najniższa
zaobserwowana wartość to 7, a najwyższa aż 53.2 mln dolarów. **area** -
Średnia powierzchnia to 478.5 m2. Najmniejsza nieruchomość ma
powierzchnię 153.3 m2 a największa 1503 m2. Dla połowy nieruchomości
powierzchnia nie przekracza 427.4m2. **bedrooms** - Nieruchomości mają
od 1 do 6 sypialni, połowa z nich nie ma więcej niż 3 sypialnie.
**bathrooms** - Nieruchomości mają od 1 do 4 łazienki, jednak połowa z
nich ma jedynie 1 łazienkę **stories** - Nieruchomości mają od 1 do 4
pięter, połowa z nich nie ma więcej niż 2 pięter. **mainroad** -
Większość nieruchomości ma dostęp do drogi głównej. **guestroom** -
Większość nieruchomości nie posiada pokoju gościnnego. **basement** -
Większość nieruchomości nie posiada piwnicy **hotwaterheating** -
Większość nieruchomości nie ma systemu podgrzewania wody
**airconditioning** - Większość nieruchomości nie ma klimatyzacji
**parking** - Nieruchomości mają liczbę miejsc parkingowych od 0 do 3
jednak większość z nich, nie posiada miejsca parkingowego.
**furnishingstatus** - Istnieje 178 nieruchomości nieumeblowanych, 227
nieruchomości średnio umeblowanych, oraz 140 nieruchomości całkowicie
umeblowanych.

```{r}
describe(dane)
```

## Podsumowanie opisu danych

zmierzenie tendencji centralnej rozkładu cen

```{r kable_report, echo=FALSE}
library(kableExtra)

dane_sorted <- dane[order(dane$bedrooms), ]
mieszkania_list <- split(dane_sorted$price, dane_sorted$bedrooms)

# Tworzenie ramki danych dla tabeli
inline_plot <- data.frame(
  bedrooms = unique(dane_sorted$bedrooms),
  boxplot = "",
  histogram = "",
  line1 = "",
  line2 = "",
  points1 = ""
)

# Obliczenie tendencji centralnej rozkładu cen
mean_price <- mean(dane_sorted$price)
median_price <- median(dane_sorted$price)
mode_price <- names(sort(table(dane_sorted$price), decreasing = TRUE))[1]

# Dodanie obliczeń do tabeli
inline_plot$Mean <- mean_price
inline_plot$Median <- median_price
inline_plot$Mode <- mode_price

inline_plot %>%
  kbl(booktabs = TRUE) %>%
  kable_paper(full_width = FALSE) %>%
  column_spec(2, image = spec_boxplot(mieszkania_list)) %>%
  column_spec(3, image = spec_hist(mieszkania_list)) %>%
  column_spec(4, image = spec_plot(mieszkania_list, same_lim = TRUE)) %>%
  column_spec(5, image = spec_plot(mieszkania_list, same_lim = FALSE)) %>%
  column_spec(6, image = spec_plot(mieszkania_list, type = "p"))


```

Podsumowanie podstawowych miar tendencji centralnej dla cen według
liczby sypialni

```{r kable_report2, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
library(psych)
raport <-
  list("Cena w PLN" =
       list("Min"= ~ min(price),
            "Max"= ~ max(price),
            "Kwartyl dolny"= ~ quantile(price,0.25),
            "Mediana"= ~ round(median(price),2),
            "Kwartyl górny"= ~ quantile(price,0.75),
            "Średnia"= ~ round(mean(price),2),
            "Odch. std."= ~ round(sd(price),2),
            "IQR"= ~ round(iqr(price),2),
            "Odchylenie ćwiartkowe"=~round(iqr(price)/2,2),
            "Odch. std. w %"=~round((sd(price)/mean(price)),2),
            "Odch. ćwiartkowe w %"=~round((iqr(price)/median(price)),2),
            "Skośność"=~round(skew(price),2),
            "Kurtoza"=~round(kurtosi(price),2)
            ))
tabela<-summary_table(dane, summaries = raport, by = c("bedrooms"))

knitr::kable(tabela,
  digits = 2,
  align = "lcccc",
  caption="Tabela 1. Mieszkania- ceny w mln PLN wg liczby sypialni",
  col.names = c("Statystyka","1 sypialnia", "2 sypialnie", "3 sypialnie", "4 sypialnie", "5 sypialnie", "6 sypialnie")) 
```

Drugi sposob:

```{r}
library(gtsummary)
dane %>%
  select(price,bedrooms) %>%
  tbl_summary(
    by=bedrooms,
    type = all_continuous() ~ "continuous2",
    statistic = all_continuous() ~ c(
      "{N_nonmiss}","{mean}","{sd}",
      "{median} ({p25}, {p75})",
      "{min}, {max}"),
    missing = "no",
    label = price ~ "Cena") %>%
  modify_header(label ~ "**Zmienna**") %>%
  modify_caption("**Tabela 1. Rozkład cen wg liczby sypialni**") %>%
  bold_labels() %>% 
  add_p(pvalue_fun = ~ style_pvalue(.x, digits = 2))
```

## Macierze korelacji

```{r bivariate, echo=FALSE, warning=TRUE}
corrplot(cor(dane[,1:4]), method = "number", type = "upper", diag =FALSE)

corr_matrix<-cor(dane[,1:4])
corrplot(corr_matrix, method="color")


```

Analiza korelacji na wykresie ukazuje powiązania pomiędzy ceną a
rozmiarem mieszkania, ilością sypialni, łazienek oraz liczbą pięter.
Najwyższa korelacja występuje między ceną a powierzchnią (0.54) oraz
ceną a ilością łazienek (0.52), co sugeruje, że istnieje umiarkowany
dodatni związek między tymi zmiennymi. Innymi słowy, wzrost ceny często
idzie w parze z większą powierzchnią mieszkania i większą liczbą
łazienek.

# 4. Wnioskowanie (testy statystyczne)

W badaniu dotyczącym cen nieruchomości przeprowadzono szereg testów
statystycznych, mających na celu zbadanie związków między cenami a
różnymi zmiennymi, w tym powierzchnią mieszkania.

##Test i wykresy normalności##\
H0: normalność rozkładu

```{r}
normalnosc_test <- shapiro.test(dane$price)
print(normalnosc_test)
plot.new()
hist(dane$price, freq = FALSE, main = "Histogram zmiennej price z krzywą gęstości", xlab = "price", col="lightblue", ylim = c(0, 0.08))
lines(density(dane$price), col = "blue", lwd = 2)
curve(dnorm(x, mean = mean(dane$price), sd = sd(dane$price)), col = "red", lwd = 2, add = TRUE)
legend("topright", legend = c("Histogram", "Density", "Normal Distribution"), col = c("black", "blue", "red"), lwd = 2)


```

## Jednorodność wariancji

```{r}
var(dane$price)
##55.97671
var(dane$area)
##40647.65
var.test(dane$price, dane$area, alternative="greater")  
```

Wynik testu wariancji sugeruje, że istnieją istotne różnice w
wariancjach między grupami (p \< 0,05). Ponadto, wartość F jest bardzo
niska (0.0013771), co sugeruje, że wariancje między grupami są bardzo
małe w porównaniu do wariancji wewnątrzgrupowej. Możemy więc wnioskować,
że wariancje między grupami są istotnie różne, co może mieć istotne
konsekwencje dla analizy statystycznej.

## Test Wilcoxona

```{r}
wilcox.test(dane$price, dane$area)

```

Test Wilcoxona dla porównania między zmiennymi price (cena) i area
(powierzchnia) wykazał bardzo istotną różnicę pomiędzy grupami. Wartość
p-value jest bardzo niska (\< 2.2e-16), co oznacza, że istnieje istotna
różnica w rozkładach obu zmiennych. Alternatywna hipoteza zakłada, że
prawdziwa różnica w lokalizacji (medianie) między grupami nie wynosi
zero. Wartość statystyki testowej W wynosi 0, co sugeruje, że wartość
testu Wilcoxona jest bardzo niska, co oznacza, że rozkłady między
zmiennymi różnią się znacząco.

## Shapiro test dla zmiennej price

```{r}
shapiro_test <- shapiro.test(dane$price)
print(shapiro_test)
```

Wynik testu Shapiro-Wilka dla zmiennej price wskazuje na istotną
statystycznie różnicę od rozkładu normalnego (p \< 0,05). Oznacza to, że
zmienna price nie pochodzi z rozkładu normalnego. Wartość p równa
3.155e-16 jest znacznie mniejsza niż 0,05, co sugeruje, że istnieją
istotne odstępstwa od normalności.

## Shapiro test dla zmiennej area

```{r}
shapiro_test_area <- shapiro.test(dane$area)
print(shapiro_test_area)
```

Wynik testu Shapiro-Wilka dla zmiennej area również wskazuje na istotną
statystycznie różnicę od rozkładu normalnego (p \< 0,05). Wartość p jest
bardzo bliska zeru (mniejsza niż 2.2e-16), co oznacza, że istnieją
istotne odstępstwa od normalności.

# Testy porównawcze

## Test T-studenta porównujący średnie ceny dla nieruchomości z i bez klimatyzacji

```{r}
library(stats)
t_test_result <- t.test(price ~ airconditioning, data = dane)
print(t_test_result)
```

Wynik testu t-studenta wskazuje na istotną statystycznie różnicę między
nieruchomościami z i bez klimatyzacji (p \< 0,05).

Wartość t = -10.659 oznacza, że istnieje istotna różnica między średnimi
cenami nieruchomości w grupach z i bez klimatyzacji. df (stopnie
swobody) wynoszące 262.47 oznacza, że stopnie swobody zostały oszacowane
na 262.47, co odzwierciedla uwzględnienie nieliniowych efektów. Wartość
p \< 2.2e-16 oznacza, że istnieje bardzo mała szansa, że obserwowana
różnica między grupami jest wynikiem czystego przypadku. Interval
ufności 95% (-8.630878, -5.939369) wskazuje, że średnia cena
nieruchomości w grupie z klimatyzacją jest prawdopodobnie między -8.63 i
-5.94 punktów procentowych niższa niż w grupie bez klimatyzacji. Średnia
cena nieruchomości w grupie bez klimatyzacji wynosi 16.77, a w grupie z
klimatyzacją wynosi 24.05. W związku z tym można stwierdzić, że istnieje
istotna różnica w cenach nieruchomości między grupami z i bez
klimatyzacji, przy czym ceny nieruchomości z klimatyzacją są wyższe.

## Test anova dla zmiennej pokoje

```{r}
anova_result <- aov(price ~ bedrooms, data = dane)
summary(anova_result)
```

Przeprowadzony test statystyczny ma dużą istotność, nie mamy więc
podstaw do odrzucenia hipotezy zerowej. Wartość F jest stosunkowo wysoka
(84.25), co wskazuje na istotny efekt grupowy. Oznacza to, że różnice w
cenach nieruchomości między grupami sypialni są wystarczająco duże, aby
uznać je za istotne statystycznie.Wartość p wynosi mniej niż ustalony
poziom istotności (zwykle 0.05), co oznacza, że istnieją statystycznie
istotne różnice w cenach nieruchomości między grupami sypialni.

## Udział mieszkań z różnym stanem umeblowania na rynku nieruchomości

```{r}
library(ggplot2)
count <- table(dane$furnishingstatus)
df <- data.frame(furnishingstatus = names(count), count = as.numeric(count))
df$percent <- df$count / sum(df$count) * 100

ggplot(df, aes(x = "", y = count, fill = furnishingstatus)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start=0) +
  scale_fill_manual(values = c("grey", "lightblue", "darkblue")) +  # Ustawiamy kolory
  theme_void() +
  geom_text(aes(label = paste0(round(percent), "%")), position = position_stack(vjust = 0.5)) +  # Dodajemy etykiety procentowe
  labs(title = "Udział rodzaju umeblowania")  # Dodajemy tytuł
```

## Badanie rozkładu ilości sypialni względen ceny nieruchomości

```{r}
set.seed(545)
#install.packages("ggstatsplot")
library(ggstatsplot)
ggbetweenstats(
  data  = dane,
  x     = bedrooms,
  y     = price,
  title = "Rozkład ilości sypialni względem ceny nieruchomości"
)
```

Najwyższe piki cenowe zostały odnotowane dla mieszkań posiadających 4
pokoje, niewiele niższą ceną szczycą się mieszkania 3 pokojowe.
Mieszkania o większej ilosci pokoi mają niższy rozkład cen, na co
wpływać może również obecność innych udogodnień takich jak preferowana
okolica, dostęp do piwnicy bądź też klimatyzacja.

## Wizualizacja

```{r}
ggscatterstats(
  data  = dane,
  x     = price,
  y     = area,
  xlab  = "Price",
  ylab  = "Area",
  title = "Zależność ceny od powierzchni"
)

```

Wykres pokazuje zależność ceny nieruchomkości od jej powierchni. Widać,
że najwieszą część rynku stanowią mniejsze nieruchomości w niższych
cenach. Ceny mieszkań o powierzchni większej w zdecydowanej większości
są wyższe niż tych mniejszych.

*Badanie udziału mieszkań na rynku posiadających dostęp do drogi
głównej*

# 5. Podsumowanie i wnioski końcowe

Dane które zostały przeanaliwane zawarte w zbiorze danych dotyczyły
nieruchomosci z agencji nieruchomości. W wielu przypadkach więcej nie
oznaczało lepiej pod względem cenowym. Jak się okazuje najdroższe
nieruchomości nie posiadały maksymalnej liczby sypialni czy też pięter
bądź łazienek. Na cenę zdecydowanie miało wpływ umeblowanie oraz
klimatyzacja. Dane były bardzo dokładne oraz "czyste" o czym świadczy
chociażby brak brakujących obserwacji czy poprawny zapis danych.
Najliczniejszą grupą nieruchomości były te, które posiadały mniej niż 3
sypialnie. Średnia powierzchnia nieruchomości wynosiła 478,5 m\^2.
Większość nieruchomości nie posiadała piwnic. Dość logiczną, aczkolwiek
wartą podkreślenia obserwacją był fakt, że brak podłączenia drogi
głównej do nieruchomości obniżał wartość nieruchomości względem tych,
kóre wspomniany dostep posiadały.
