---
title: "Agencja nieruchomości"
author: "grupaA"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
library(arules)
library(hms)
library(readxl)
library(ggplot2)
library(dplyr)
#library(ggstatsplot)
library(magrittr)
library(gt)
library(lubridate)
library(gtsummary)
library(summarytools)
library(qwraps2)
library(kableExtra)
if (!require(outliers)) {
  install.packages("outliers")
  library(outliers)
  library(Hmisc)
}
library(psych)
#install.packages("corrplot")
library(corrplot)

#install.packages("tidyverse")
#install.packages("ggforce")
library(tidyverse)
library(ggforce)

#install.packages("psych")
library(psych)

#install.packages("gridExtra")
library(gridExtra)


```

# Wstep

## Opis problemu

Przedmiotem rozważań niniejszego opracowania są ceny wybranych
nieruchomości. Celem badania jest wyselekcjonowanie czynników mogących
istotnie wpływać na cenę domu.

## Baza danych

Podstawą analizy jest baza danych nieruchomości wystawionych na
sprzedaż, dostępnych w pewnej agencji nieruchomości.

```{r}
# wczytanie danych
library(readxl) 
dane <- read.csv("agencja_nieruchomosci.csv")

# wyświetlenie pierwszych wierszy danych
kable(head(dane))
```

## Zmienne

Dane poddane analizie zawieraja ponizsze zmienne:

-   **price** - cena nieruchomości w dolarach

-   **area** - całkowita powierzchnia domu w stopach kwadratowych

-   **bedrooms** - liczba sypialni w domu

-   **bathrooms** - liczba łazienek w domu

-   **stories** - liczba pięter w domu

-   **mainroad** - czy dom jest połączony z główną drogą (Tak/Nie)

-   **guestroom** - czy dom posiada pokój gościnny (Tak/Nie)

-   **basement** - czy dom jest podpiwniczony (Tak/Nie)

-   **hotwaterheating** - czy dom posiada system ogrzewania ciepłej wody
    (Tak/Nie)

-   **airconditioning** - czy dom posiada system klimatyzacji (Tak/Nie)

-   **parking** - liczba miejsc parkingowych dostępnych w budynku

-   **prefarea** - czy dom znajduje się w preferowanym obszarze
    (Tak/Nie)

-   **furnishingstatus** - status umeblowania domu (w pełni umeblowany,
    częściowo umeblowany, nieumeblowany)

```{r}
# struktura danych 
str(dane)
```

# 1. Data Cleansing, Wrangling

## Walidacja danych

### dane w kolumnach gdzie yes/no

Zbior danych posiada kolumny zawierajace dane "yes" "no". Zastąpimy te
dane w taki sposób, że: no-"0" yes-"1" dla kolumn: mainroad, guestroom,
basement, hotwaterheating, airconditioning, prefarea.

```{r}
# zamiana yes/no na 1/0
dane$mainroad <- ifelse(dane$mainroad == 'yes', 1, 0)
dane$guestroom  <- ifelse(dane$guestroom  == 'yes', 1, 0)
dane$basement  <- ifelse(dane$basement  == 'yes', 1, 0)
dane$hotwaterheating  <- ifelse(dane$hotwaterheating  == 'yes', 1, 0)
dane$airconditioning  <- ifelse(dane$airconditioning  == 'yes', 1, 0)
dane$prefarea  <- ifelse(dane$prefarea  == 'yes', 1, 0)
```

### dane z kolumny furnishingstatus

W przypadku kolumny furnishingstatus zmienimy poniższe statusty na
wartości: unfurnished - "0" semi-furnished - "1" furnished - "2"

```{r}
# Zamiana wartości w kolumnie 'furnishingstatus'
dane$furnishingstatus <- ifelse(dane$furnishingstatus == 'unfurnished', 0,
                                  ifelse(dane$furnishingstatus == 'semi-furnished', 1,
                                         ifelse(dane$furnishingstatus == 'furnished', 2, NA)))

```

### dane z kolumny price

Dane z kolumny price zamienimy z cen w dolarach na ceny w polskich
złotych.

```{r}
# Kurs wymiany
kurs_wymiany <- 4.00
# 1USD=4.00PLN na dzien 4/02/2024

# Przeliczenie cen z dolarów na złote
dane$price <- dane$price * kurs_wymiany

```

### dane z kolumny area

Natomiast dane z kolumny area zamienimy z powierzchni mierzonej w
stopach kwadratowych na powierzchnię mierzoną w metrach kwadratowych.

```{r}
# Współczynnik konwersji z stóp kwadratowych na metry kwadratowe
wspolczynnik_konwersji <- 0.092903

# Przeliczenie powierzchni z stóp kwadratowych na metry kwadratowe
dane$area <- dane$area * wspolczynnik_konwersji
```

```{r}
# ponowne wyswietlenie struktura danych 
str(dane)
```

### Sprawdzenie czy występują brakujące dane

```{r}
data.frame(braki = sapply(dane, function(x) sum(is.na(x))))

```

W zbiorze nie występują braki danych.

Sprawdzamy jakie skrajne wartosci osiagaja poszczegolne zmienne.

```{r}
# zakres osiąganych wartości dla zmiennych ilościowych
describe(dane[,c(1:5,11)])[8:9]
```

Jak widać ceny osiągają milionowe wartości. Aby nie operować bardzo
dużymi liczbami wyrazimy je w mln PLN.

```{r}
# przeliczenia wartości zmiennej price 
dane <- dane %>%
  mutate(price = price/10^6)
```

### Sprawdzenie czy w danych występują duplikaty

```{r}
# Przypisanie danych bez duplikatów do nowej zmiennej
dane_unikalne <- unique(dane)

# Sprawdzenie, czy oryginalne dane zawierają duplikaty
czy_duplikaty <- anyDuplicated(dane) > 0

# Wyświetlenie informacji o duplikatach
if (czy_duplikaty) {
  print("Dane zawierają duplikaty.")
} else {
  print("Brak duplikatów w danych.")
}
```

Sprawdzamy czy w zbiorze danych wystepuja wartosci ujemne. W zadnej
zmiennej wartosci nie powinny byc ujemne.

```{r}
# Sprawdzenie, czy istnieją wartości ujemne w dowolnej kolumnie
czy_sa_ujemne <- any(sapply(dane, function(x) any(x < 0)))

# Wyświetlenie informacji
if (czy_sa_ujemne) {
  print("W ramce danych są wartości ujemne.")
} else {
  print("Brak wartości ujemnych w ramce danych.")
}

```

## Dane odstające

### Sprawdzenie obserwacji odstających -jednowymiarowe

```{r}

par(mfrow = c(2, 2), cex.axis = 1.5, las = 2, mar = c(5, 5, 2, 2))
for (col in colnames(dane)) {
  if (is.numeric(dane[[col]])) {
    boxplot(dane[[col]], 
            main = paste("Wykres pudełkowy dla zmiennej\n", col), 
            ylab = col,
            col = "lightgreen",
            border = "darkgreen",
            pch = 18,
            cex = 1.5,
            cex.main = 1
    )
    outliers <- boxplot.stats(dane[[col]])$out
    points(which(dane[[col]] %in% outliers), outliers, pch = 4, col = "red", cex = 0.5)
  }
}
```

Cena: W zmiennej price, można zaobserwować zmienne odstające powyżej 35
mln PLN. Może być to związen z dużym metrażem nieruchomości, atrakycjną
lokalizacją, liczbą sypialni, lub poziomem umeblowania

Powierzchnia: Można zaobserwować zmienne odstające dla powierzchni
powyżej 850m2. Może być to związane z liczbą pięter, lub dużą ilością
pomieszczeń takich jak sypialnia czy łazienka.

Sypialnie: Istnieją nieruchomości posiadające 5 i 6 sypialni, które to
wartości należą do zmiennych odstających w analizowanym zakresie.
Wiekszość nieruchmości jest w przedziale 2-3 sypialnie.

Lazienki: Znaczaca wiekszosc posiada do 2 lazienek. Natomiast istnieje
zmienna odstająca, wskazująca na 4 łazienki w nieruchomości.

Piętra: Nieruchomosci posiadaja glownie 1-2 pietra, istnieje zmienna
odstajaca, wskazujaca na 4 pietra w nieruchmosci

Miejsca parkingowe: Dla zbioru danych, mozna zaobserwować zmienną
odstającą wskazujacą, że istnieją nieruchomości z 3 miejscami
parkingowymi.

### Sprawdzenie obserwacji odstających - wielowymiarowych

Poniżej przygotowano wykresy rozrzutu dla posiadanych danych.

```{r}
# Stworzenie wykresu punktowego (scatterplot matrix) z dostosowanymi parametrami
par(mfrow = c(1, 1), mar = c(2, 2, 2, 2))  # Ustawienie jednego obszaru wykresu i marginesów
pairs(dane[, sapply(dane, is.numeric)], pch = 16, col = "darkgreen", cex = 1.5)

# Dodanie oznaczenia dla obserwacji odstających
outliers <- lapply(dane[, sapply(dane, is.numeric)], function(x) boxplot.stats(x)$out)
outliers <- do.call(cbind, outliers)
points(outliers[1, ], outliers[2, ], pch = 4, col = "red", cex = 1.5)


```

Poniżej indentyfikacja, w ktorych kolumnach (zmiennych) znajduja sie
wartosci odstajace na podstawie odchylenia sandardowego.

Każdy rząd odpowiada za inną zmienną związaną z nieruchomościami: cena,
powierzchnia, liczba sypialni, liczba łazienek, liczba pięter, główna
droga, pokój gościnny, piwnica, ogrzewanie ciepłej wody, klimatyzacja,
parking, preferowany obszar i stan umeblowania.

Każda kolumna reprezentuje indywidualną obserwację lub nieruchomość.
Zielone paski wskazują, w jakim stopniu każda obserwacja jest uważana za
odstającą dla każdej zmiennej; wyższe paski wskazują, że obserwacja jest
bardziej uważana za odstającą.

Identyfikacja obserwacji odstających w danych liczbowych przy założeniu,
że wartość bezwzględna wieksza niż 3:

```{r}
kolumny <- c("price", "area", "bedrooms", "bathrooms", "stories", "parking")
conditions <- as.data.frame(lapply(dane[, kolumny], function(x) abs(scale(x)) > 3))
summary(conditions)

```

Cena: 6 wartosci odstajacych z 545 nieruchomosci

Powierzchnia: 7 wartosci odstajacych z 545 nieruchomosci

Sypialnie: 2 wartosci odstajace z 545 nieruchomosci

Lazienki: az 11 wartosci odstajacych z 545 nieruchomosci

Pietra: brak wartosci odstajacych - wszystkie nieruchomosci maja podobna
liczbe pieter

Parking: brak wartosci odstajacych - wszystkie nieruchomosci maja
podobna liczbe miejsc parkingowych

### Test Grubbsa (test T)

```{r}
#Test Grubbsa dla zmiennej price (cena)
grubbs.test(dane$price)
```

Test Grubbsa jest stosowany do wykrywania pojedynczych wartości
odstających w zestawie danych.

Wyniki testu Grubbsa można zinterpretować następująco:

G = 4.56217: To jest statystyka testowa Grubbsa. Jeżeli jest duża,
sugeruje to, że dane mogą zawierać wartość odstającą.

U = 0.96167: To jest zmodyfikowana statystyka Grubbsa, która jest
używana do obliczenia p-wartości.

p-value = 0.001126: To jest p-wartość testu. Jeżeli jest mała (zazwyczaj
poniżej 0.05), odrzucamy hipotezę zerową, która zakłada, że nie ma
wartości odstających. W tym przypadku, p-wartość jest mała (0.001126),
więc odrzucamy hipotezę zerową i stwierdzamy, że jest co najmniej jedna
wartość odstająca.

alternative hypothesis: highest value 53.2 is an outlier: To jest
alternatywna hipoteza, która jest przyjmowana, gdy odrzucamy hipotezę
zerową. W tym przypadku, sugeruje ona, że najwyższa wartość (53.2) jest
wartością odstającą.

Poniżej Test Grubbsa dla pozostalych zmiennych:

```{r}
grubbs.test(dane$area)
grubbs.test(dane$bedrooms)
grubbs.test(dane$bathrooms)
grubbs.test(dane$stories)
grubbs.test(dane$parking)
```

**Obserwujemy dane odstajace w zmiennych: price (wczesniej wymienione),
area, bedrooms i bathrooms. W przypadku zmiennych stories oraz parking
nie zaobserwowano wartosci odstajacych.**

# 2. Wizualizacja Danych

W tej części opracowano wizualizację danych w postaci: wizualizacja
ilości, wizualizacja rozkładów, wizualizacja proporcji, wizualizacja
trendów.

## Wizualizacja zmiennych - histogramy

Poniżej przedstawiamy wizualizację zmiennych dla naszego zbioru danych

```{r}
# Histogramy dla zmiennych ilościowych
par(mfrow=c(3, 2)) # Ustawienie układu wykresów

hist(dane$price, main = 'Rozkład ceny', xlab = 'Cena', col = 'lightblue', border = 'black')
hist(dane$area, main = 'Rozkład powierzchni', xlab = 'Powierzchnia', col = 'lightblue', border = 'black')
hist(dane$bedrooms, main = 'Rozkład liczby sypialni', xlab = 'Liczba sypialni', col = 'lightblue', border = 'black')
hist(dane$bathrooms, main = 'Rozkład liczby łazienek', xlab = 'Liczba łazienek', col = 'lightblue', border = 'black')
hist(dane$stories, main = 'Rozkład liczby pięter', xlab = 'Liczba pięter', col = 'lightblue', border = 'black')
hist(dane$parking, main = 'Rozkład liczby miejsc parkingowych', xlab = 'Liczba miejsc parkingowych', col = 'lightblue', border = 'black')

# Wykresy słupkowe dla zmiennych jakościowych
par(mfrow=c(2, 3)) # Ustawienie układu wykresów

barplot(table(dane$mainroad), main = 'Dostępność do głównej drogi', xlab = 'Dostęp do głównej drogi', col = 'lightblue', border = 'black')
barplot(table(dane$guestroom), main = 'Czy występuje pokój gościnny', xlab = 'Pokój gościnny', col = 'lightblue', border = 'black')
barplot(table(dane$basement), main = 'Czy występuje piwnica', xlab = 'Piwnica', col = 'lightblue', border = 'black')
barplot(table(dane$hotwaterheating), main = 'Czy system ogrzewania wody', xlab = 'System ogrzewania wody', col = 'lightblue', border = 'black')
barplot(table(dane$airconditioning), main = 'Czy występuje klimatyzacja', xlab = 'Klimatyzacja', col = 'lightblue', border = 'black')
barplot(table(dane$prefarea), main = 'Czy nieruchomość występuje w preferowanym obszarze', xlab = 'Preferowany obszar', col = 'lightblue', border = 'black')
barplot(table(dane$furnishingstatus), main = 'Stopień umeblowania', xlab = 'Stopień umeblowania', col = 'lightblue', border = 'black')



```

## Wizualizacja rozkładów

### Histogramy rozkładu cen nieruchomości względem zmiennych

Poniżej przedstawiamy analizę rozkładu cen nieruchomości w zależności od
różnych cech, takich jak liczba sypialni, łazienek czy pięter.
Histogramy prezentują, jak ceny zmieniają się w zależności od tych cech,
co pomaga zrozumieć ich wpływ na wartość nieruchomości.

```{r}
# Tworzenie histogramu wzgledem liczby sypialni
ggplot(dane, aes(x = bedrooms, y = price, fill = factor(bedrooms))) +  # Ustawienie danych i zmiennej x na liczba sypialni, zmienna y na ceny, wypełnienie koloru w zależności od liczby sypialni
  geom_histogram(stat = "identity", position = "dodge", color = "black") +  # Wyświetlenie histogramu z użyciem koloru czarnego
  labs(title = "Rozkład cen względem liczby sypialni", x = "Liczba sypialni", y = "Cena") +  # Dodanie tytułu i etykiet osi x oraz y
  theme_minimal() +  # Wybór minimalistycznego motywu wyglądu
  scale_fill_brewer(palette = "Set3")  # Wybór palety kolorów dla różnych liczby sypialni

# Tworzenie histogramu wzgledem liczby lazienek
ggplot(dane, aes(x = bathrooms, y = price, fill = factor(bathrooms))) +  
  geom_histogram(stat = "identity", position = "dodge", color = "black")+ 
  labs(title = "Rozkład cen względem liczby lazienek", x = "Liczba lazienek", y = "Cena") + theme_minimal() + scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu wzgledem liczby pieter
ggplot(dane, aes(x = stories, y = price, fill = factor(stories))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem liczby pięter", x = "Liczba pięter", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu cen względem głównej drogi (mainroad)
ggplot(dane, aes(x = mainroad, y = price, fill = factor(mainroad))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem głównej drogi", x = "Główna droga (1=Tak, 0=Nie)", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")


# Tworzenie histogramu cen względem pokoju gościnnego (guestroom)
ggplot(dane, aes(x = guestroom, y = price, fill = factor(guestroom))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem pokoju gościnnego", x = "Pokój gościnny (1=Tak, 0=Nie)", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu cen względem piwnicy (basement)
ggplot(dane, aes(x = basement, y = price, fill = factor(basement))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem piwnicy", x = "Piwnica (1=Tak, 0=Nie)", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu cen względem  ogrzewania wodą (hotwaterheating)
ggplot(dane, aes(x = hotwaterheating, y = price, fill = factor(hotwaterheating))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem ogrzewania wodą", x = "Ogrzewanie wodą (1=Tak, 0=Nie)", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu cen względem klimatyzacji (airconditioning)
ggplot(dane, aes(x = airconditioning, y = price, fill = factor(airconditioning))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem klimatyzacji", x = "Klimatyzacja (1=Tak, 0=Nie)", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu cen względem parkingu (parking)
ggplot(dane, aes(x = parking, y = price, fill = factor(parking))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem parkingu", x = "Parking (1=Tak, 0=Nie)", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu cen względem preferowanej okolicy (prefarea)
ggplot(dane, aes(x = prefarea, y = price, fill = factor(prefarea))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem preferowanej okolicy", x = "Preferowana okolica (1=Tak, 0=Nie)", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")

# Tworzenie histogramu cen względem  statusu umeblowania (furnishingstatus)
ggplot(dane, aes(x = furnishingstatus, y = price, fill = factor(furnishingstatus))) +
  geom_histogram(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Rozkład cen względem statusu umeblowania", x = "Status umeblowania", y = "Cena") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")






```

### Wizualizacja gęstości cen względem zmiennych

W poniższym fragmencie kodu prezentujemy analizę gęstości cen
nieruchomości względem różnych cech, takich jak liczba sypialni,
łazienek, pięter itp. Wizualizacje gęstości pomagają zrozumieć, jak
zmienia się rozkład cen w zależności od poszczególnych cech
nieruchomości.

Gęstość w kontekście analizy danych oznacza, jak często i w jakim
stopniu wartości zmiennej (np. ceny nieruchomości) skupiają się w
określonych przedziałach. Wykres gęstości pokazuje, jak rozkładają się
wartości zmiennej na osi numerycznej, gdzie wyższe wartości oznaczają
obszary większego skupienia. Innymi słowy, obszary wyższej gęstości
wskazują na większe prawdopodobieństwo wystąpienia wartości w danym
przedziale, co pozwala lepiej zrozumieć charakterystykę danych i ich
rozkład.

```{r}

# Wizualizacji gęstości cen względem liczby sypialni
ggplot(dane, aes(x = price, fill = factor(bedrooms))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem liczby sypialni", x = "Cena", y = "Gęstość") +
  theme_minimal()


# Wizualizacji gęstości cen względem liczby łazienek
ggplot(dane, aes(x = price, fill = factor(bathrooms))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem liczby łazienek", x = "Cena", y = "Gęstość") +
  theme_minimal()


# Wizualizacji gęstości cen względem liczby pięter
ggplot(dane, aes(x = price, fill = factor(stories))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem liczby pięter", x = "Cena", y = "Gęstość") +
  theme_minimal()

# Wizualizacji gęstości cen względem głównej drogi
ggplot(dane, aes(x = price, fill = factor(mainroad))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem głównej drogi", x = "Cena", y = "Gęstość") +
  theme_minimal()

# Wizualizacji gęstości cen względem pokoju gościnnego
ggplot(dane, aes(x = price, fill = factor(guestroom))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem pokoju gościnnego", x = "Cena", y = "Gęstość") +
  theme_minimal()

# Wizualizacji gęstości cen względem piwnicy
ggplot(dane, aes(x = price, fill = factor(basement))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem piwnicy", x = "Cena", y = "Gęstość") +
  theme_minimal()

# Wizualizacji gęstości cen względem ogrzewania wodą
ggplot(dane, aes(x = price, fill = factor(hotwaterheating))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem ogrzewania wodą", x = "Cena", y = "Gęstość") +
  theme_minimal()

# Wizualizacji gęstości cen względem klimatyzacji
ggplot(dane, aes(x = price, fill = factor(airconditioning))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem klimatyzacji", x = "Cena", y = "Gęstość") +
  theme_minimal()

# Wizualizacji gęstości cen względem parkingu
ggplot(dane, aes(x = price, fill = factor(parking))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem parkingu", x = "Cena", y = "Gęstość") +
  theme_minimal()

# Wizualizacji gęstości cen względem preferowanej okolicy
ggplot(dane, aes(x = price, fill = factor(prefarea))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem preferowanej okolicy", x = "Cena", y = "Gęstość") +
  theme_minimal()


# Wizualizacji gęstości cen względem statusu umeblowania
ggplot(dane, aes(x = price, fill = factor(furnishingstatus))) +
  geom_density(alpha = 0.6, color = "black") +
  labs(title = "Wizualizacja gęstości cen względem statusu umeblowania", x = "Cena", y = "Gęstość") +
  theme_minimal()

```

**Gęstość cen względem liczby sypialni** Analizujac wykres gestosci ceny
wzgledem liczby pokoi mozemy zaobserwowac, ze największa gęstość cen
występuje dla mieszkań z jedną sypialnią, cena rośnie wraz ze wzrostem
liczby sypialni oraz, że mieszkania z większą liczbą sypialni są
rzadziej dostępne na rynku, co jest widoczne na wykresie przez niższą
gęstość.

**Gęstość cen względem liczby łazienek** Największa gęstość cen
występuje dla mieszkań z jedną sypialnią. Cena rośnie wraz ze wzrostem
liczby sypialni, co widać na wykresie poprzez przesunięcie szczytów fal
w prawo. Mieszkania z większą liczbą sypialni są rzadziej dostępne na
rynku, co jest widoczne na wykresie przez niższą gęstość dla fal
reprezentujących większą liczbę sypialni.

//opisac reszte tzreba bedzie

## Wizualizacja proporcji

```{r}
dane %>%
  gather(key = "variable", value = "value", -price, -area) %>%
  group_by(variable, value) %>%
  summarise(n = n()) %>%
  mutate(percentage = n / sum(n)) -> dane_wiz

# Stwórz wykres
ggplot(dane_wiz, aes(x = value, y = percentage, fill = variable)) +
  geom_col(position = "dodge") +
  facet_wrap(~variable, scales = "free", ncol = 4)
  theme_minimal() +
  labs(x = "Wartości", y = "Proporcja (%)", fill = "Zmienna (kolumna",
       title = "Proporcje zmiennych w zbiorze danych")

```

Powyższa wizualizacja proporcji nie uwzględnia zmiennej price oraz
zmiennej area. Ponizej wizualizacja z uwzględnieniem tych dwóch
zmiennych, jednak ze względu na chatakterystykę danych, z podziałem na 3
przedziały.

```{r}
#library(tidyverse)

# Podział zmiennych "price" i "area" na przedziały
dane %>%
  mutate(price_category = cut(price, breaks = 3),
         area_category = cut(area, breaks = 3)) %>%
  group_by(price_category, area_category) %>%
  summarise(n = n()) %>%
  mutate(percentage = n / sum(n)) -> dane_proporcje

# Stworzenie wizualizacji proporcji dla każdej kategorii
ggplot(dane_proporcje, aes(x = price_category, y = area_category, fill = percentage)) +
  geom_tile() +
  scale_fill_gradient(low = "lightblue", high = "darkblue") +
  labs(x = "price", y = "area", fill = "Proporcje (%)") +
  theme_minimal() +
  ggtitle("Proporcje w zależności od ceny i powierzchni")


```

Powyższa mapa cieplna jest wizualizacją proporcji zmiennych price i
area. Oś x przedstawia ceny (price z podzialem na 3 przedziały,
natomiast oś y przedstawia zmienną area również z podziałem na 3
przedziały. Większość danych (około 80%) dotyczy nieruchomości o
średniej cenie i sredniej powierzchni. Najmniej danych (blisko 0%)
dotyczy nieruchomości o niskiej cenie i dużej powierzchni oraz o
wysokiej cenie i małej powierzchni.

```{r}


dane %>%
  ggplot(aes(price, area,size = bathrooms, color = factor(stories))) +
  labs(x = "Cena",
       y = "Powierzchnia",
       size = "Liczba sypialni \n(rozmiar punktorow)",
       color = "Liczba lazienek \n(kolor punktorow)") +
  geom_point(alpha = 0.8)


```

## Wizualizacja trendów.

Wykres rozrzutu (scatter plot) jest jednym z podstawowych narzędzi do
analizy trendów w danych. Wizualizuje relacje miedzy dwoma zmienymi, w
tym przypadku powierzchni do ceny co moze pomoc w indenyfkacji trendów.

```{r}
# wykres rozrzutu
ggplot(dane, aes(x = area, y = price)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)


```

Mamy tutaj zależność dodatnią, czym większa powierzchnia domu, tym
wyższa cena. Jednak układ punktów nie wskazuje na ściśły związek
liniowy. Ponieważ jednak nie ma tu też zależności nieliniowej.

# 3. Analiza opisowa

W naszym zbiorze danych występują zmienne ilościowe: price, area,
bedrooms, bathrooms, stories, parking; oraz zmienne jakościowe:
mainroad, guestroom, basement, hotwaterheating, airconditioning,
prefarea, furnishingstatus.

# Analiza eksploracyjna

Przystępujemy do analizy struktury poszczególnych zmiennych. Dla
zmiennych jakościowych sporządzamy wykres słupkowy rozkładu
procentowego, dla zmiennych ilościowych obliczamy podstawowe miary
rozkładu i sporządzamy histogram.

## Price

Cena to zmienna ilościowa.

```{r}
# statystyki opisowe
#kable(describe(dane[,1])[c(2:5,8,9,11,12)])
kable(describe(dane))
```

Średnia cena badanych nieruchomości to 19.1 mln PLN, przy czym ceny
poszczególnych domów różnią się od średniej przeciętnie o 7.48 mln PLN.
Dla połowy nieruchomości cena nie przekracza 17.36 mln PLN Najniższa
zaobserwowana wartość to 7, a najwyższa aż 53.2 mln dolarów.

```{r}
ggplot(dane, aes(x = price)) + 
  geom_histogram(colour = "black", fill = "#FFFF99", bins = 10) +
  labs(title = "Price", 
       x = " million PLN", y = "n") +
  theme(plot.title = element_text(hjust = 0.5, size = 12))

```

W rozkładzie dobrze widoczna jest asymetria prawostronna (wydłużona
ramię z prawej strony).

Aby nie tworzyć oddzielnej tabeli i wykresu dla każdej zmiennej
objaśniającej bedziemy rozpatrywac je wspólnie.

## Ilościowe zmienne objaśniające

```{r}
#statystyki opisowe
kable(describe(dane[,c(1:5,11)])[c(1:5,8,9,11,12)])
```

Wyniki interpretuje się analogicznie jak w przypadku ceny.

```{r}
# histogramy dla zmiennych ilościowych
plot1 <- ggplot(dane, aes(x = area)) + 
  geom_histogram(colour = "black", fill = "#FFFF99", bins = 10) +
  labs(title = "Area", 
       x = "metry kwadratowe", y = "n") +
  theme(plot.title = element_text(hjust = 0.5, size = 12))

plot2 <- ggplot(dane, aes(x = bedrooms)) + 
  geom_histogram(colour = "black", fill = "#FFFF99", bins = 10) +
  labs(title = "Bedrooms", 
       x = "liczba", y = "n") +
  theme(plot.title = element_text(hjust = 0.5, size = 12))

plot3 <- ggplot(dane, aes(x = bathrooms)) + 
  geom_histogram(colour = "black", fill = "#FFFF99", bins = 10) +
  labs(title = "Bathrooms", 
       x = "liczba", y = "n") +
  theme(plot.title = element_text(hjust = 0.5, size = 12))

plot4 <- ggplot(dane, aes(x = stories)) + 
  geom_histogram(colour = "black", fill = "#FFFF99", bins = 10) +
  labs(title = "Stories", 
       x = "liczba", y = "n") +
  theme(plot.title = element_text(hjust = 0.5, size = 12))

plot5 <- ggplot(dane, aes(x = parking)) + 
  geom_histogram(colour = "black", fill = "#FFFF99", bins = 10) +
  labs(title = "Parking", 
       x = "liczba", y = "n") +
  theme(plot.title = element_text(hjust = 0.5, size = 12))

grid.arrange(plot1, plot2, plot3, plot4, plot5, nrow = 2)
```

W przypadku powierzchni również mamy asymetrię prawostronną. Pozostałe
zmienne to zmienne skokowe (przyjmujące tylko całkowite wartości), przy
tak małym zakresie osiąganych wartości można je też potraktować jak
zmienne jakościowe.

## Jakościowe zmienne objaśniające

```{r,}
# wykres słupkowy dla zmiennej mainroad
tab <- as.data.frame(100*prop.table(table(dane$mainroad)))
plot1 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Mainroad",
       y = "%")

# wykres słupkowy dla zmiennej guestroom
tab <- as.data.frame(100*prop.table(table(dane$guestroom)))
plot2 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Guestroom",
       y = "%")

# wykres słupkowy dla zmiennej basement
tab <- as.data.frame(100*prop.table(table(dane$basement)))
plot3 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Basement",
       y = "%")

# wykres słupkowy dla zmiennej hotwaterheating
tab <- as.data.frame(100*prop.table(table(dane$hotwaterheating)))
plot4 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Hotwaterheating",
       y = "%")

# wykres słupkowy dla zmiennej airconditioning
tab <- as.data.frame(100*prop.table(table(dane$airconditioning)))
plot5 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Airconditioning",
       y = "%")

# wykres słupkowy dla zmiennej prefarea
tab <- as.data.frame(100*prop.table(table(dane$prefarea)))
plot6 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Prefarea",
       y = "%")

# wykres słupkowy dla zmiennej furnishingstatus
tab <- as.data.frame(100*prop.table(table(dane$furnishingstatus)))
plot7 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Furnishingstatus",
       y = "%")

# wykres wspólny
grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, plot7, nrow = 4)
```

Mamy duże dysproporcje w rozkładzie kategorii poszczególnych zmiennych.

Powyższe dane zostaly wyswietlone w części dotyczącej wizualizacji
danych, jednak dla spójności analizy ponawiamy je w tej części. \# TUTAJ
JEST COS NIE TAK\~! (ponizej)

```{r kable_report2, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
library(questionr)
library(stats)
raport <- list("Cena w PLN" =
                list("Min"= ~ min(price),
                     "Max"= ~ max(price),
                     "Kwartyl dolny"= ~ quantile(price,0.25),
                     "Mediana"= ~ round(median(price),2),
                     "Kwartyl górny"= ~ quantile(price,0.75),
                     "Średnia"= ~ round(mean(price),2),
                     "Odch. std."= ~ round(sd(price),2),
                     "IQR"= ~ round(IQR(price),2),
                     "Odchylenie ćwiartkowe"=~round(iqr(price)/2,2),
                     "Odch. std. w %"=~round((sd(price)/mean(price)),2),
                     "Odch. ćwiartkowe w %"=~round((iqr(price)/median(price)),2),
                     "Skośność"=~round(skew(price),2),
                     "Kurtoza"=~round(kurtosis(price),2)
                )
)
tabela <- summary_table(dane, summaries = raport, by = c("bedrooms"))

knitr::kable(tabela,
             digits = 2,
             align = "lcccc",
             caption = "Tabela 1..",
             col.names = c("Statystyka", "1 pokój", "2 pokoje", "3 pokoje", "4 pokoje")) 

```

```{r}

#library(ggplot2)
#library(corrplot)

# Wybrane zmienne ilościowe
zmienne_ilosciowe <- c("price", "area", "bathrooms", "bedrooms", "stories", "parking")

# Tworzenie macierzy korelacji dla wybranych zmiennych
corr_matrix <- cor(dane[, zmienne_ilosciowe])

# Konfiguracja wykresu z większym dolnym marginesem
par(mar = c(12, 2, 1, 1))

# Tworzenie mapy cieplnej z adnotacjami
corrplot(corr_matrix, method = "color", type = "upper", 
         order = "hclust", tl.cex = 0.7, tl.col = "black", tl.srt = 45)

# Dodanie tytułu z większym dolnym marginesem
title(main = "Mapa macierzy korelacji", col.main = "blue", font.main = 4, cex.main = 1.2)


```

Mapa ta przedstawia korelację między różnymi zmiennymi (kolumnami) dla
nieruchomosci w agencji nieruchomosci

Pozytywne korelacje są oznaczone na niebiesko, a negatywne na czerwono;
im ciemniejszy kolor, tym silniejsza korelacja. - price ma silną
pozytywną korelację z area, co widać po ciemnoniebieskim kolorze. -
mainroad ma negatywną korelację z stories, co widać po jasnoczerwonym
kolorze. Pola na przekątnej od lewego górnego do prawego dolnego rogu są
wszystkie ciemnoniebieskie, co wskazuje, że każda zmienna ma doskonałą
pozytywną korelację ze sobą

# 4. Wnioskowanie (testy statystyczne)

# 5. Podsumowanie i wnioski końcowe


```{r}
# roboczy chunk

```

```{r}
# ilość braków danych dla poszczególnych zmiennych
data.frame(braki = sapply(dane, function(x) sum(is.na(x)))) 
# w danych nie występują braki

#weryfikacja outlierów dla ceny zależej od powierzchni

plot(dane$area, dane$price, main="Rozrzut cen vs. powierzchnia", xlab="Powierzchnia", ylab="Cena") 
outliers <- boxplot(dane$price ~ dane$area, plot=FALSE)$out
# Wyświetlenie wartości odstających
if (length(outliers) > 0) {
  cat("Wartości odstające dla ceny:\n")
  print(outliers)
} else {
  cat("Brak wartości odstających dla ceny.\n")
}

#wyszły wartości odstające dla cen: #9240000 2345000 1750000 6650000 6160000 8890000 6405000 5033000 8400000 9681000 4690000 2870000 9100000
# wartości te mogą być odstające ze zwględu na inne udogodnienia jak klimatyzacja, dostęp do głównej drogi itp więc nie możemy wykluczyć ich z dalszej analizy
```

```{r}

# sprawdzanie korelacji między danymi

# Konwersja zmiennych kategorycznych na numeryczne

dane$mainroad <- as.numeric(dane$mainroad == "yes")
dane$guestroom <- as.numeric(dane$guestroom == "yes")
dane$basement <- as.numeric(dane$basement == "yes")
dane$hotwaterheating <- as.numeric(dane$hotwaterheating == "yes")
dane$airconditioning <- as.numeric(dane$airconditioning == "yes")
dane$prefarea <- as.numeric(dane$prefarea == "yes")
dane$furnishingstatus <- as.numeric(factor(dane$furnishingstatus, levels= c("unfurnished", "semi-furnished", "furnished")))

correlation_matrix <- cor(dane) 
print(correlation_matrix)

install.packages("corrplot") 
library(corrplot)
corrplot(correlation_matrix, method="circle") 
# najwększe korelacje występują między ceną a ilościa łazienek, powierzchnią lub klimatyzacją. Trochę mniejsze między ilością sypialni, stories bądź iloscią miejsc parkingowych a ceną

```

```{r}
#obliczenie ceny za metr 
dane$cena_na_metr <- dane$price / dane$area

#analiza częstości występowania zmiennych kategorycznych - "udogodnień"
# Częstość dostępu do drogi
table(dane$mainroad)
# Średnia cena dla dostępu do drogi
aggregate(dane$price, by = list(dane$mainroad), FUN = mean)
# Wykres pudełkowy dla ceny w zależności od dostępu do drogi
boxplot(dane$price ~ dane$mainroad, main="Ceny w zależności od dostępu do drogi", xlab="Dostęp do drogi", ylab="Cena", col="lightblue")
```

```{r}

# Częstość preferowanej okolicy
table(dane$prefarea)
# Średnia cena dla preferowanej okolicy
aggregate(dane$price, by = list(dane$prefarea), FUN = mean)
# Wykres pudełkowy dla ceny w zależności od preferowanej okolicy
boxplot(dane$price ~ dane$prefarea, main="Ceny w zależności od preferowanej okolicy", xlab="Preferowana okolica", ylab="Cena", col="lightgreen")
```

```{r}
# Częstość posiadania piwnicy
table(dane$basement)
# Średnia cena dla posiadania piwnicy
aggregate(dane$price, by = list(dane$basement), FUN = mean)
# Wykres pudełkowy dla ceny w zależności od posiadania piwnicy
boxplot(dane$price ~ dane$basement, main="Ceny w zależności od posiadania piwnicy", xlab="Posiadanie piwnicy", ylab="Cena", col="lightcoral")
```

```{r}
# Częstość posiadania klimatyzacji
table(dane$airconditioning)
# Średnia cena dla posiadania klimatyzacji
aggregate(dane$price, by = list(dane$airconditioning), FUN = mean)
# Wykres pudełkowy dla ceny w zależności od posiadania klimatyzacji
boxplot(dane$price ~ dane$airconditioning, main="Ceny w zależności od klimatyzacji", xlab="Klimatyzacja", ylab="Cena", col="lightyellow")
```

```{r}
# Częstość posiadania miejsc parkingowych
table(dane$parking)
# Średnia cena dla posiadania miejsc parkingowych
aggregate(dane$price, by = list(dane$parking), FUN = mean)
# Wykres pudełkowy dla ceny w zależności od posiadania miejsc parkingowych
boxplot(dane$price ~ dane$parking, main="Ceny w zależności od miejsc parkingowych", xlab="Miejsca parkingowe", ylab="Cena", col="lightblue")
```

```{r}
# Częstość statusu umeblowania
table(dane$furnishingstatus)
# Średnia cena dla różnych statusów umeblowania
aggregate(dane$price, by = list(dane$furnishingstatus), FUN = mean)
# Wykres pudełkowy dla ceny w zależności od statusu umeblowania
boxplot(dane$price ~ dane$furnishingstatus, main="Ceny w zależności od statusu umeblowania", xlab="Status umeblowania", ylab="Cena", col="lightgreen")

```

```{r}
# Utworzenie ramki danych z średnimi cenami dla różnych kategorii

# Utworzenie ramki danych z średnimi cenami dla różnych kategorii
avg_prices <- aggregate(dane$price, by = list(dane$mainroad, dane$prefarea, dane$basement, dane$hotwaterheating, dane$airconditioning, dane$parking, dane$furnishingstatus), FUN = mean)
# Nadanie odpowiednich nazw kolumn w ramce danych
colnames(avg_prices) <- c("mainroad", "prefarea", "basement", "hotwaterheating", "airconditioning", "parking", "furnishingstatus", "avg_price")
# Wykres słupkowy grupowy
library(ggplot2)
ggplot(avg_prices, aes(x = mainroad, y = avg_price, fill = prefarea)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(. ~ basement + hotwaterheating + airconditioning + parking + furnishingstatus) +
  labs(title = "Średnie ceny nieruchomości w zależności od różnych kategorii",
       x = "Dostęp do drogi", y = "Średnia cena") +
  theme_minimal()
```

```{r}
# Utworzenie ramki danych zawierającej kolumny z ceną i kategoriami udogodnień
df <- data.frame(
  price = dane$price,
  mainroad = as.factor(dane$mainroad),
  prefarea = as.factor(dane$prefarea),
  basement = as.factor(dane$basement),
  hotwaterheating = as.factor(dane$hotwaterheating),
  airconditioning = as.factor(dane$airconditioning),
  parking = as.factor(dane$parking),
  furnishingstatus = as.factor(dane$furnishingstatus)
)

# Przy użyciu ggplot2
library(ggplot2)

ggplot(df, aes(x = interaction(mainroad, prefarea, basement, hotwaterheating, airconditioning, parking, furnishingstatus), y = price)) +
  geom_boxplot(fill = "lightblue") +
  labs(title = "Zależność ceny od różnych udogodnień",
       x = "Udogodnienia",
       y = "Cena") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# za wiele nie widać na wykresach wspólnych ( dużo danych mało miejsca ) więc nie wiem czy nie lepiej zrobić to w oddzielnych

```
